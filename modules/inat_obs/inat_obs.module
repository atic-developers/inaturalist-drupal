<?php
  /**
   * iNaturalist observations module
   * Copyright 2014 Projecte Ictineo SCCL (www.projecteictineo.com)
   * aGPLv3
   */

/**
 * Implements hook_menu()
 */
function inat_obs_menu() {
  $items = array();

  //$items['inat/observations'] = array(
    //'title' => t(''),
    //'description' => t(''),
    //'page callback' => '',
    //'access arguments' => '',
    //'menu_name' => 'inaturalist'
    //'type' => MENU_NORMAL_ITEM,
  //);

  $items['inat/observations'] = array(
    'title' => t('Observations'),
    'description' => t('iNaturalist Observations'),
    'page callback' => 'inat_page_observations',
    'access arguments' => 'access inaturalist content',
    'menu_name' => 'menu-inaturalist',
    'type' => MENU_NORMAL_ITEM,
  );

  return $items;
}

/**
 * Implements hook_theme
 */
function inat_obs_theme($existing, $type, $theme, $path) {
  return array(
    'inat_observations' => array(
      'variables' => array('content' => NULL),
      'template' => 'observations',
      'path' => drupal_get_path('module', 'inat_obs') . '/theme',
    )
  );
}



/**
 * helper functions
 */
// http://www.slideshare.net/jkopel/pnwds-api

function inat_page_observations() {
  $verb = 'observations.json';
  $query = array('per_page' => '2', 'order_by' => 'observed_on');
  $options = array('query' => $query, 'https' => FALSE);
  $url = url(variable_get('inat_base_url','http://www.inaturalist.org') . '/' . $verb, $options);
  $options = array('method' => 'GET');
  $result = drupal_http_request($url, $options);
  $json = drupal_json_decode($result->data);
  
  //return var_export($json);
  return theme('inat_observations', array('content' => $json));
}
